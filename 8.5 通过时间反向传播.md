# 通过时间反向传播
正向传播和反向传播相互依赖。正向传播在循环神经⽹络中⽐较直观，而通过时间反向传播其实是反向传播在循环神经⽹络中的具体应⽤。需要将循环神经⽹络按时间步展开，从而得到模型变量和参数之间的依赖关系，并依据链式法则应⽤反向传播计算并存储梯度。
## 1 定义模型
简单起⻅，考虑⼀个⽆偏差项的循环神经⽹络，且激活函数为恒等映射（ϕ(x)=x）。设时间步t的输⼊为单样本xt∈Rd，标签为yt，那么隐藏状态ht∈Rh的计算表达式为

<div align=center>
    ![image](https://raw.githubusercontent.com/zhiyuanz-hub/public-picture/master/21-1.png)
</div> 

其中Whx∈Rh×d和Whh∈Rh×h是隐藏层权重参数。设输出层权重参数Wqh∈Rq×h，时间步t的输出层变量ot∈Rq计算为

<div align=center>
    ![image](https://raw.githubusercontent.com/zhiyuanz-hub/public-picture/master/21-2.png)
</div> 

设时间步t的损失为ℓ(ot,yt)。时间步数为T的损失函数L定义为

<div align=center>
    ![image](https://raw.githubusercontent.com/zhiyuanz-hub/public-picture/master/21-3.png)
</div> 

将L称为有关给定时间步的数据样本的⽬标函数。
## 2 模型计算图
为了可视化循环神经⽹络中模型变量和参数在计算中的依赖关系，可以绘制模型计算图，如图所⽰。例如，时间步3的隐藏状态h3的计算依赖模型参数Whx、Whh、上⼀时间步隐藏状态h2以及当前时间步输⼊x3。

<div align=center>
    ![image](https://raw.githubusercontent.com/zhiyuanz-hub/public-picture/master/21-4.png)
</div>
## 3 方法

⾸先，⽬标函数有关各时间步输出层变量的梯度很容易计算：

<div align=center>
    ![image](https://raw.githubusercontent.com/zhiyuanz-hub/public-picture/master/21-5.png)
</div>

下⾯，可以计算⽬标函数有关模型参数Wqh的梯度。依据链式法则，

<div align=center>
    ![image](https://raw.githubusercontent.com/zhiyuanz-hub/public-picture/master/21-6.png)
</div>

其次，注意到隐藏状态之间也存在依赖关系。依据链式法则，得到

<div align=center>
    ![image](https://raw.githubusercontent.com/zhiyuanz-hub/public-picture/master/21-7.png)
</div>

接下来对于时间步t<T，L通过ht+1和ot依赖ht。依据链式法则，⽬标函数有关时间步t<T的隐藏状态的梯度需要按照时间步从⼤到小依次计算：

<div align=center>
    ![image](https://raw.githubusercontent.com/zhiyuanz-hub/public-picture/master/21-8.png)
</div>

将上⾯的递归公式展开，对任意时间步1≤t≤T，可以得到⽬标函数有关隐藏状态梯度的通项公式

<div align=center>
    ![image](https://raw.githubusercontent.com/zhiyuanz-hub/public-picture/master/21-9.png)
</div>

由上式中的指数项可⻅，当时间步数T较⼤或者时间步t较小时，⽬标函数有关隐藏状态的梯度较容易出现衰减和爆炸。L通过h1,..,hT依赖这些模型参数。依据链式法则，有

<div align=center>
    ![image](https://raw.githubusercontent.com/zhiyuanz-hub/public-picture/master/21-10.png)

    ![image](https://raw.githubusercontent.com/zhiyuanz-hub/public-picture/master/21-11.png)
</div>

最后对本节进行一个小结：
+ 通过时间反向传播是反向传播在循环神经⽹络中的具体应⽤。
+ 当时间步数较⼤或者时间步较小时，循环神经⽹络的梯度较容易出现衰减或爆炸。


