# 多尺度目标检测
锚框是对输⼊图像不同区域的采样。然而，如果以图像每个像素为中⼼都⽣成锚框，很容易⽣成过多锚框而造成计算量过⼤。举个例⼦，假设输⼊图像的⾼和宽分别为561像素和728像素，如果以每个像素为中⼼⽣成5个不同形状的锚框，那么⼀张图像上则需要标注并预测200多万个锚框（561× 728× 5）。减少锚框个数并不难。⼀种简单的⽅法是在输⼊图像中均匀采样⼀小部分像素，并以采样的像
素为中⼼⽣成锚框。此外，在不同尺度下，可以⽣成不同数量和不同⼤小的锚框。值得注意的是，较小⽬标⽐较⼤⽬标在图像上出现位置的可能性更多。举个简单的例⼦：形状为1 × 1、1 × 2和2 × 2的⽬标在形状为2 × 2的图像上可能出现的位置分别有4、 2和1种。因此，当使⽤较小锚框来检测较小⽬标时，可以采样较多的区域；而当使⽤较⼤锚框来检测较⼤⽬标时，可以采样较少的区域。

为了演⽰如何多尺度⽣成锚框，先读取⼀张图像。它的⾼和宽分别为561像素和728像素。

in[1]: %matplotlib inline

       import d2lzh as d2l

       from mxnet import contrib, image, nd

       img = image.imread('../img/catdog.jpg')

       h, w = img.shape[0:2]

       h, w

out[1]: (561, 728)

下⾯定义display_anchors函数。在特征图fmap上以每个单元（像素）为中⼼⽣成锚
框anchors。由于锚框anchors中x和y轴的坐标值分别已除以特征图fmap的宽和⾼，这些值
域在0和1之间的值表达了锚框在特征图中的相对位置。由于锚框anchors的中⼼遍布特征
图fmap上的所有单元， anchors的中⼼在任⼀图像的空间相对位置⼀定是均匀分布的。具
体来说，当特征图的宽和⾼分别设为fmap_w和fmap_h时，该函数将在任⼀图像上均匀采
样fmap_h⾏fmap_w列个像素，并分别以它们为中⼼⽣成⼤小为s（假设列表s⻓度为1）的不
同宽⾼⽐（ratios）的锚框。

in[2]: d2l.set_figsize()

    def display_anchors(fmap_w, fmap_h, s):

        fmap = nd.zeros((1, 10, fmap_w, fmap_h)) // 前两维的取值不影响输出结

        anchors = contrib.nd.MultiBoxPrior(fmap, sizes=s, ratios=[1, 2, 0.5])

        bbox_scale = nd.array((w, h, w, h))

        d2l.show_bboxes(d2l.plt.imshow(img.asnumpy()).axes,anchors[0] * bbox_scale)

先关注小⽬标的检测。为了在显⽰时更容易分辨，这⾥令不同中⼼的锚框不重合：设锚框⼤
小为0.15，特征图的⾼和宽分别为4。可以看出，图像上4⾏4列的锚框中⼼分布均匀。

In [3]: display_anchors(fmap_w=4, fmap_h=4, s=[0.15])

<div align=center>
    ![image](https://raw.githubusercontent.com/zhiyuanz-hub/public-picture/master/19-1.jpg)
</div>

将特征图的⾼和宽分别减半，并⽤更⼤的锚框检测更⼤的⽬标。当锚框⼤小设0.4时，有些锚
框的区域有重合。

In [4]: display_anchors(fmap_w=2, fmap_h=2, s=[0.4])

<div align=center>
    ![image](https://raw.githubusercontent.com/zhiyuanz-hub/public-picture/master/19-2.jpg)
</div>

最后，将特征图的⾼和宽进⼀步减半⾄1，并将锚框⼤小增⾄0.8。此时锚框中⼼即图像中⼼。

In [5]: display_anchors(fmap_w=1, fmap_h=1, s=[0.8])

<div align=center>
    ![image](https://raw.githubusercontent.com/zhiyuanz-hub/public-picture/master/19-3.jpg)
</div>

既然已在多个尺度上⽣成了不同⼤小的锚框，相应地，需要在不同尺度下检测不同⼤小
的⽬标。下⾯来介绍⼀种基于卷积神经⽹络的⽅法。

在某个尺度下，假设依据ci张形状为h×w的特征图⽣成h×w组不同中⼼的锚框，且每组的锚框个数为a。例如，在刚才实验的第⼀个尺度下，依据10（通道数）张形状为4×4的特征图⽣成了16组不同中⼼的锚框，且每组含3个锚框。接下来，依据真实边界框的类别和位置，每个锚框将被标注类别和偏移量。在当前的尺度下，⽬标检测模型需要根据输⼊图像预测h×w组不同中⼼的锚框的类别和偏移量。

假设这⾥的ci张特征图为卷积神经⽹络根据输⼊图像做前向计算所得的中间输出。既然每张特征图上都有h×w个不同的空间位置，那么相同空间位置可以看作含有ci个单元。根据“⼆维卷积层” ⼀节中感受野的定义，特征图在相同空间位置的ci个单元在输⼊图像上的感受野相同，并表征了同⼀感受野内的输⼊图像信息。因此，可以将特征图在相同空间位置的ci个单元变换为以该位置为中⼼⽣成的a个锚框的类别和偏移量。不难发现，本质上，⽤输⼊图像在某个感受野区域内的信息来预测输⼊图像上与该区域位置相近的锚框的类别和偏移量。

当不同层的特征图在输⼊图像上分别拥有不同⼤小的感受野时，它们将分别⽤来检测不同⼤小的⽬标。例如，可以通过设计⽹络，令较接近输出层的特征图中每个单元拥有更⼴阔的感受野，从而检测输⼊图像中更⼤尺⼨的⽬标。

最后进行一下小结：
+ 可以在多个尺度下⽣成不同数量和不同⼤小的锚框，从而在多个尺度下检测不同⼤小的⽬
标。
+ 特征图的形状能确定任⼀图像上均匀采样的锚框中⼼。
+ ⽤输⼊图像在某个感受野区域内的信息来预测输⼊图像上与该区域相近的锚框的类别和偏
移量。